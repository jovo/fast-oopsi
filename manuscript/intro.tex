\section{Introduction}

\paragraph{Motivation}

Simultaneously imaging large populations of neurons using calcium sensors is becoming increasingly popular, both in vitro  \cite{ImagingManual} and in vivo \cite{NagayamaChen07, GobelHelmchen07, LuoSvoboda08}, especially as the signal-to-noise-ratio (SNR) of genetic sensors continues to improve \cite{GaraschukKonnerth07, MankGriesbeck08, WallaceHasan08}. Whereas the data from these experiments are movies of time-varying fluorescence signals, the desired signal is typically the spike trains or firing rates of the observable neurons.  Importantly, to a first approximation, somatic calcium concentration has a relatively simple relationship to spikes.  Thus, in theory, one could infer the most likely spike train of each neuron, given the fluorescence data.  

\paragraph{Limitations of calcium imaging}

Unfortunately, finding the most likely spike train is a challenging computational task, for a number of reasons.  First, the signal-to-noise ratio (SNR) is often low, especially as one increases the image field and frame rate.  Second, to find the most likely spike train for a given fluorescence signal, one would have to search over all possible spike trains, a search that would take far too long, in practice.  

\paragraph{Computational tools as important as experimental tools}

One is therefore effectively forced to find an approximately most likely spike train, or guess that the inferred spike train is most likely (but not really be sure).  The precise details of these approximations, however, are crucial, especially as one approaches shot-noise limited data. For in vitro studies, one often uses 1-photon imaging --- either confocal or widefield --- in which case the number of photons per neuron is a function of magnification and frame rate (obviously, other parameters, such as number of sensors per neuron, are also important, but typically more difficult to control).  To maximize the amount of information one can extract from such preparations, one should increase the frame rate and image field until achieving the shot noise limited regime, assuming one has an inference algorithm that can operate in such a scenario.  For in vivo studies, 2-photon laser scanning microscopy is currently the method of choice, for which the SNR is relatively low,  because the dwell time per pixel is (frame duration)/($\#$ of pixels in frame).  To circumvent the low SNR for in vivo studies, some groups use long integration times (e.g., \cite{OhkiReid06}), whereas others use small image fields (e.g., \cite{KerrHelmchen07}).  One would prefer to neither sacrifice temporal resolution nor number of observable neurons, to get sufficient signal quality to perform reliable inference.  Therefore, it is of the utmost importance to extract as much information as possible from the signal; especially if one is asking quantitative questions about the statistics of the spike trains from the observable neurons --- either spontaneously or in relation to some sensorimotor stimulus.

\paragraph{Previous approaches}

A number of groups have therefore proposed algorithms to infer spike trains from calcium fluorescence data.  For instance, Greenberg et al. \cite{GreenbergKerr08} developed a novel template matching algorithm, which performed well on their data, but is not particularly computationally efficient.  Holekamp et al. \cite{HolekampHoly08} took a very different strategy, by performing the optimal linear deconvolution (i.e., the Wiener filter) on the fluorescence data.  This approach is natural from a signal processing standpoint, but does not utilize the knowledge that spikes are always positive.  In our previous work \cite{VogelsteinPaninski09}, we developed a sequential Monte Carlo method to efficiently compute the approximate probability of a spike in each image frame, given the entire fluorescence time series.   While effective, that approach is not suitable for online analyses of populations of neurons, as the computations run in approximately real-time (i.e., analyzing one minute of data requires about one minute of computational time).

\paragraph{Our approach}

The present work takes a somewhat different approach.  First, we carefully consider the statistics of typical data-sets, and then write down a generative model that accurately relates spiking to observations. Unfortunately, inferring the most likely spike train given this model is computationally intractable.  We therefore make some well-justified approximations, which lead to an algorithm that infers the approximately most likely spike train, given the fluorescence data.  Our algorithm has a few particularly noteworthy features, relative to other approaches.  First, we assume that spikes are always non-negative (i.e., either positive or zero).  This is often an important assumption when searching for non-negative signals \cite{LeeSeung99, LeeSeung01, HuysPaninski06}.  Second, our algorithm is extremely fast: it can process a calcium trace from 50,000 images in about one second on a standard laptop computer.  Because of these two features, we call our approach the Fast Optimal OPtical Spike Inference (\foopsi) filter. In addition to these two features, we can generalize our model in a number of ways. The efficacy of the proposed filter is demonstrated on several real data-sets, suggesting this algorithm is a powerful tool for spike train inference.  The code (which is a simple Matlab script) is available from the authors upon request. 